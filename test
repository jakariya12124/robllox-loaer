local Players = game:GetService("Players")
local Workspace = game:GetService("Workspace")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer
local enabled = false
local warnings = 0
local MAX_WARNINGS = 3
local CHECK_INTERVAL = 1
local DISTANCE_THRESHOLD = 60

-- Wait until PlayerGui is ready
local playerGui
repeat
	playerGui = player:FindFirstChild("PlayerGui")
	wait(0.1)
until playerGui

-- Create GUI safely
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "AntiESP_ToggleGui"
screenGui.ResetOnSpawn = false
screenGui.Parent = playerGui

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 180, 0, 50)
frame.Position = UDim2.new(1, -190, 0, 20)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.BackgroundTransparency = 0.15
frame.Parent = screenGui
frame.AnchorPoint = Vector2.new(1, 0)
frame.Active = true
frame.Draggable = true

local stroke = Instance.new("UIStroke")
stroke.Color = Color3.fromRGB(0, 200, 255)
stroke.Thickness = 2
stroke.Parent = frame

local toggleBtn = Instance.new("TextButton")
toggleBtn.Size = UDim2.new(1, 0, 1, 0)
toggleBtn.Position = UDim2.new(0, 0, 0, 0)
toggleBtn.BackgroundColor3 = Color3.fromRGB(10, 90, 120)
toggleBtn.TextColor3 = Color3.fromRGB(220, 220, 220)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 16
toggleBtn.Text = "Activate Anti-ESP"
toggleBtn.AutoButtonColor = true
toggleBtn.BorderSizePixel = 0
toggleBtn.Parent = frame

local function stripVisualESPTools(character)
	for _, v in ipairs(character:GetDescendants()) do
		if v:IsA("Highlight") or v:IsA("SelectionBox") or v:IsA("BoxHandleAdornment") then
			v:Destroy()
		elseif v:IsA("SurfaceAppearance") then
			v:Destroy()
		elseif v:IsA("BasePart") and v.Material == Enum.Material.Neon then
			v.Material = Enum.Material.Plastic
		end
	end
end

local function hasLineOfSight(target)
	local char1 = player.Character
	local char2 = target.Character
	if not (char1 and char2) then return false end

	local hrp1 = char1:FindFirstChild("HumanoidRootPart")
	local hrp2 = char2:FindFirstChild("HumanoidRootPart")
	if not (hrp1 and hrp2) then return false end

	local rayParams = RaycastParams.new()
	rayParams.FilterDescendantsInstances = {char1}
	rayParams.FilterType = Enum.RaycastFilterType.Blacklist

	local result = Workspace:Raycast(hrp1.Position, hrp2.Position - hrp1.Position, rayParams)
	return result and char2:IsAncestorOf(result.Instance)
end

local function warn()
	warnings = warnings + 1
	warn("[ANTI-ESP] Warning " .. warnings .. " â€” suspicious ESP detected!")

	if warnings >= MAX_WARNINGS then
		-- Kick yourself safely
		pcall(function()
			player:Kick("Anti-ESP kicked you for suspicious behavior.")
		end)
	end
end

local lastCheck = 0
RunService.RenderStepped:Connect(function(dt)
	if not enabled then return end
	lastCheck = lastCheck + dt
	if lastCheck < CHECK_INTERVAL then return end
	lastCheck = 0

	if not player.Character or not player.Character:FindFirstChild("HumanoidRootPart") then return end
	local char1 = player.Character

	for _, other in ipairs(Players:GetPlayers()) do
		if other ~= player and other.Character and other.Character:FindFirstChild("HumanoidRootPart") then
			local dist = (char1.HumanoidRootPart.Position - other.Character.HumanoidRootPart.Position).Magnitude

			-- Remove ESP visuals locally
			pcall(stripVisualESPTools, other.Character)

			if dist > DISTANCE_THRESHOLD then
				if hasLineOfSight(other) then
					warn()
				end
			end
		end
	end
end)

toggleBtn.MouseButton1Click:Connect(function()
	enabled = not enabled
	if enabled then
		toggleBtn.Text = "Disable Anti-ESP"
		toggleBtn.BackgroundColor3 = Color3.fromRGB(0, 150, 50)
	else
		toggleBtn.Text = "Activate Anti-ESP"
		toggleBtn.BackgroundColor3 = Color3.fromRGB(10, 90, 120)
		warnings = 0
	end
end)
