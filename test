-- Natural Valex-Style Fly with Smooth Rotation + Mobile Joystick + After Death Support

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local player = Players.LocalPlayer

local speed = 50
local gravityPull = -8
local flying = false

local bv, bg, humanoid, root

-- GUI setup (same as before)
local gui = Instance.new("ScreenGui")
gui.Name = "ValexFlyGUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 130, 0, 50)
frame.Position = UDim2.new(0.5, -65, 0.75, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BackgroundTransparency = 0.2
frame.BorderSizePixel = 0
frame.Active = true
frame.Draggable = true
frame.Parent = gui

local button = Instance.new("TextButton")
button.Size = UDim2.new(1, 0, 1, 0)
button.Text = "Fly: OFF"
button.TextColor3 = Color3.new(1, 1, 1)
button.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
button.Font = Enum.Font.GothamBold
button.TextScaled = true
button.Parent = frame

-- Helper for smooth gyro rotation
local function lerpCFrame(a, b, alpha)
	local qa = {a:GetComponents()}
	local qb = {b:GetComponents()}
	for i = 1, 12 do
		qa[i] = qa[i] + (qb[i] - qa[i]) * alpha
	end
	return CFrame.new(
		qa[1], qa[2], qa[3],
		qa[4], qa[5], qa[6],
		qa[7], qa[8], qa[9],
		qa[10], qa[11], qa[12]
	)
end

local function createFlight()
	if not root or not humanoid then return end

	if not bv or bv.Parent ~= root then
		bv = Instance.new("BodyVelocity")
		bv.MaxForce = Vector3.new(1e6, 1e6, 1e6)
		bv.P = 125000
		bv.Name = "FlyVelocity"
		bv.Velocity = Vector3.zero
		bv.Parent = root
	end

	if not bg or bg.Parent ~= root then
		bg = Instance.new("BodyGyro")
		bg.MaxTorque = Vector3.new(1e6, 1e6, 1e6)
		bg.P = 10000 -- lower P for smoother rotation
		bg.CFrame = workspace.CurrentCamera.CFrame
		bg.Name = "FlyGyro"
		bg.Parent = root
	end

	humanoid.PlatformStand = true
end

local function stopFlight()
	if bv then bv:Destroy() end
	if bg then bg:Destroy() end
	bv, bg = nil, nil
	if humanoid then humanoid.PlatformStand = false end
end

button.MouseButton1Click:Connect(function()
	flying = not flying
	button.Text = "Fly: " .. (flying and "ON" or "OFF")

	if flying then
		createFlight()
	else
		stopFlight()
	end
end)

RunService.RenderStepped:Connect(function()
	if flying and humanoid and root and bv and bg then
		local cam = workspace.CurrentCamera
		local move = humanoid.MoveDirection

		-- Smoothly interpolate the gyro CFrame towards camera CFrame with easing
		bg.CFrame = bg.CFrame:Lerp(cam.CFrame, 0.15) -- 0.15 controls smoothness (lower = smoother)

		local velocity = Vector3.zero
		if move.Magnitude > 0 then
			local dir = cam.CFrame:VectorToWorldSpace(move.Unit)
			velocity = dir * speed
		end

		-- Add gentle upward float, not too rigid
		velocity = velocity + Vector3.new(0, gravityPull * 0.6, 0)
		bv.Velocity = velocity
	end
end)

local function setupCharacter(char)
	humanoid = char:WaitForChild("Humanoid")
	root = char:WaitForChild("HumanoidRootPart")

	if flying then
		task.wait(0.1)
		createFlight()
	end
end

player.CharacterAdded:Connect(function(char)
	stopFlight()
	setupCharacter(char)
end)

if player.Character then
	setupCharacter(player.Character)
end
